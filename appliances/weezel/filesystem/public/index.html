<!DOCTYPE html>

<html>

  <head>

    <style>
     #canvas {
       background-color: #888;
       cursor: crosshair;
     }
    </style>

    <script>
     function getEventCoords (e) {
       let pageX, pageY
       if (e.hasOwnProperty("changedTouches")) {
         const touch = e.changedTouches[0]
         pageX = touch.pageX
         pageY = touch.pageY
       } else if (e.buttons !== 1) {
         return null
       } else {
         pageX = e.pageX
         pageY = e.pageY
       }
       const el = e.target
       const canvasX = pageX - el.offsetLeft
       const canvasY = pageY - el.offsetTop
       return [ canvasX, canvasY ]
     }

     function init () {
       const canvas = document.getElementById("canvas")
       const ctx = canvas.getContext('2d')
       let xMax, yMax
       let touchActive = false

       ctx.lineWidth = 1
       ctx.strokeStyle = "#000"

       // canvas.addEventListener("click", e => {
       //   const el = e.target
       //   const canvasX = e.pageX - el.offsetLeft
       //   const canvasY = e.pageY - el.offsetTop
       //   const deviceX = canvasX
       //   const deviceY = canvasY
       //   ctx.lineTo(canvasX, canvasY)
       //   ctx.stroke()
       //   fetch(`/move_to_point?x=${deviceX}&y=${deviceY}`)
       // })

       const ws = new WebSocket(`ws://${window.location.host}/draw`)
       let lastMoveTs = undefined
       const MIN_DELTA_MS = 100
       function moveEventHandler(e) {
         e.preventDefault()
         if (!touchActive) {
           return
         }

         const [ canvasX, canvasY ] = getEventCoords(e)
         if (canvasX === null) {
           return
         }

         if (lastMoveTs !== undefined &&
             e.timeStamp - lastMoveTs < MIN_DELTA_MS) {
           return
         }

         ctx.lineTo(canvasX, canvasY)
         ctx.stroke()
         const payload = JSON.stringify({
           event: "draw",
           x: canvasX,
           y: canvasY
         })
         ws.send(JSON.stringify(payload.length).padStart(2, "0") + payload)

         lastMoveTs = e.timeStamp
       }

       function startEventHandler(e) {
         e.preventDefault()
         touchActive = true

         const [ canvasX, canvasY ] = getEventCoords(e)
         if (canvasX === null) {
           return
         }

         ctx.moveTo(canvasX, canvasY)

         const payload = JSON.stringify({
           event: "move",
           x: canvasX,
           y: canvasY
         })
         ws.send(JSON.stringify(payload.length).padStart(2, "0") + payload)
       }

       function endEventHandler (e) {
         e.preventDefault()
         touchActive = false
       }

       canvas.addEventListener('mousedown', startEventHandler)
       canvas.addEventListener('mousemove', moveEventHandler)
       canvas.addEventListener('mouseup', endEventHandler)

       canvas.addEventListener('touchstart', startEventHandler)
       canvas.addEventListener('touchmove', moveEventHandler)
       canvas.addEventListener('touchend', endEventHandler)

       // Read the max X/Y coordinates from the device and size the canvas.
       fetch('/constants').then(
         response => response.json().then(
           data => {
             xMax = data.weezel.MAX_X
             yMax = data.weezel.MAX_Y
             canvas.width = xMax
             canvas.height = yMax
             ctx.beginPath()
             ctx.moveTo(0, 0)
           }
         )
       )

       document.getElementById('go-home').addEventListener('click', () => {
         fetch('/move_to_point?x=0&y=0')
       })

     }

     document.addEventListener("DOMContentLoaded", init)

    </script>

  </head>

  <body>
    <canvas id="canvas" width="0", height="0"></canvas>
    <br>
    <button id="go-home">Go Home</button>
  </body>

</html>
